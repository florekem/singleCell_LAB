# 01_Create Raw Seurat Object
Loading raw data. joint_bcs as intersect of gex and hto gives the same result as gex and adt. Keeping it as it is.

```{r 01_libraries}
suppressPackageStartupMessages({
  library(Seurat)
  library(DropletUtils)
  library(ggplot2)
  library(Matrix)
  library(tidyverse)
  library(clustree)
  library(reticulate) # load packages required by leiden algo
  reticulate::use_condaenv("/mnt/sda4/conda/envs/R")
  library(viridis) # colors
  library(DoubletFinder)
  options(future.globals.maxSize = 3.0 * 1e9) # 3GB
  library(sceasy) # convert to anndata, scvi integration
  library(dittoSeq)
  library(dsb)
  require(cluster)
})
```

## stuff
```{r 01_functions}
set.seed(123)

source("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/scripts/functions.R")
source("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/scripts/00_Global_vars.R")

sample_path <- file.path("/mnt/sdb1/runs/sample1_multilane_spec_index_NNN/outs/multi/count/raw_feature_bc_matrix") # nolint
```

## create sparse matrix
```{r, warning = FALSE}
sparse_matrix_list <- seu_create_sparse_matrix_list(sample_path)
```
## filter gex with DropletUtils
```{r}
sparse_matrix_filt <- filter_gex_matrix_dropletutils(sparse_matrix_list)
```
## Create Raw Seurat Object
```{r}
seu_raw_object <- create_seurat_object(sparse_matrix_filt)
```
## Demultiplex Raw Seurat Object
```{r}
seu_raw_object_demux <- seu_demultiplex(seu_raw_object)
```
## Subset singlets and negatives
```{r}
seu_singlet_negative_list <- subset_singlets(seu_raw_object_demux)
```
### Inspect Singlets and negatives
```{r}
seu_singlet_negative_list$seu_singlet
seu_singlet_negative_list$seu_negative
```
## Add quality features and cycle scroring
```{r}
seu_singlet_b4_q_filtering <- add_quality_features(
  seu_singlet_negative_list$seu_singlet
) |>
  add_cell_cycle_scoring()
```

# 02_Check Quality of the raw data
## Normalize
```{r}
seu_singlet_b4_q_filt_norm <- seu_normalize_var_scale_pca(
  seu_singlet_b4_q_filtering,
  normalize = "log",
  cluster.name = "cluster.log",
  pca.reduction.name = "pca",
  umap.reduction.name = "umap.log",
  dims = 1:30,
  k.param = 20,
  algorithm = 4,
  resolution = 0.5,
  group.singletons = TRUE
)
```
## Visualize
```{r}
viz_quality(
  seu_singlet_b4_q_filt_norm,
  assay = "RNA", q_features,
  reduction = "umap.log", gr_by_features
)
plot_scatter(seu_singlet_b4_q_filt_norm)
ElbowPlot(seu_singlet_b4_q_filt_norm, ndims = 40)
```

# 03_Subset cells based on quality assesment
## Subset
```{r}
seu_singlet_q_filt_norm <- subset(
  seu_singlet_b4_q_filt_norm,
  subset = nFeature_RNA > 200 &
    nFeature_RNA < 7000 &
    nCount_RNA < 50000 &
    nCount_RNA > 500 &
    percent_mito < 8 &
    nCount_ADT < quantile(seu_singlet_b4_q_filt_norm$nCount_ADT, 0.99)
)
```
## Visualize
```{r}
viz_quality(
  seu_singlet_q_filt_norm,
  assay = "RNA", q_features,
  reduction = "umap.log", gr_by_features
)
plot_scatter(seu_singlet_q_filt_norm)
```

# 04_Remove Doublets Using DoubletFinder
## normalize after quality subsetting (SCT)
```{r, warning = FALSE}
seu_singlet <- seu_normalize_var_scale_pca(
  seu_singlet_q_filt_norm,
  normalize = "sct",
  cluster.name = "cluster.sct",
  pca.reduction.name = "pca.sct",
  umap.reduction.name = "umap.sct",
  dims = 1:10, # change to 10 in case of removing doublets
  k.param = 20,
  algorithm = 4,
  resolution = 0.2, # res probably could be lower, like 0.2
  group.singletons = TRUE
)
DefaultAssay(seu_singlet) <- "SCT"
```
## Remove Doublets
```{r}
seu_singlet <- remove_doublets_w_dfinder(seu_singlet)
```
## subset tru singlets
```{r}
seu_singlet <- subset(
  seu_singlet,
  subset = DF.classifications_0.25_0.09_1657 == "Singlet" # generalize it!
)
```
## GEX
### Normalize and ReCluster
```{r, warning = FALSE}
seu_singlet <- seu_normalize_var_scale_pca(
  seu_singlet,
  normalize = "sct",
  cluster.name = "cluster.sct",
  pca.reduction.name = "pca.sct",
  umap.reduction.name = "umap.sct",
  dims = 1:20,
  k.param = 30,
  algorithm = 4,
  resolution = 0.1,
  group.singletons = FALSE
)
```
### Visualize
```{r}
viz_quality(
  seu_singlet,
  assay = "SCT", t_quality,
  reduction = "umap.sct", gr_by_features_sct
)
seu_dittoDotPlot(
  seu_singlet,
  vars = t_quality,
  group.by = "cluster.sct"
)
```
## ADT
### Normalize using CLR
only for reference, DSB normalization in the main one
```{r}
DefaultAssay(seu_singlet) <- "ADT"
seu_singlet <- NormalizeData(
  seu_singlet,
  assay = "ADT",
  normalization.method = "CLR"
)
```
### Visualize
```{r}
viz_quality(
  seu_singlet,
  assay = "ADT", c(t_adt_quality, isotype_controls),
  reduction = "umap.sct", gr_by_features_sct
)
seu_dittoDotPlot(
  seu_singlet,
  vars = t_adt_quality,
  group.by = "cluster.sct"
)
```

# Remove cd8+ from myeloid clusters
## Subset myeloid cluster to filter out cd8 cells -------------------
```{r subset myelo}
DefaultAssay(seu_singlet) <- "SCT"
Idents(seu_singlet) <- "cluster.sct"

seu_singlet_myelo <- subset(seu_singlet, idents = c(2, 6, 10, 11))
DefaultAssay(seu_singlet_myelo) <- "SCT"
seu_singlet_myelo
Idents(seu_singlet_myelo)

seu_singlet_myelo <- seu_normalize_var_scale_pca(
  seu_singlet_myelo,
  normalize = "sct",
  cluster.name = "cluster.sct.myelo",
  run_pca = TRUE,
  pca.reduction.name = "pca.myelo.sct",
  umap.reduction.name = "umap.myelo.pca.sct",
  dims = 1:5,
  k.param = 10,
  algorithm = 4,
  resolution = 1.2,
  group.singletons = FALSE
)
```

```{r viz isolated myelo clusters}
viz_quality(seu_singlet_myelo,
  assay = "SCT", q_features = t_quality,
  reduction = "umap.myelo.pca.sct", gr_by_features = gr_by_features_sct_myelo
)

seu_dittoDotPlot(
  seu_singlet_myelo,
  vars = vars,
  group.by = "cluster.sct.myelo"
)

DefaultAssay(seu_singlet) <- "ADT"
viz_quality(seu_singlet_myelo,
  assay = "ADT", q_features = t_adt_quality,
  reduction = "umap.myelo.pca.sct", gr_by_features = NULL
)
```

# Remove selected cells from seu_singlet (original) clusters
```{r remove cells}
Idents(seu_singlet_myelo) <- "cluster.sct.myelo"
clusters_to_remove <- subset(seu_singlet_myelo, idents = c(11, 19, 25, 28))
clusters_to_remove

seu_singlet <- subset(
  seu_singlet,
  cells = setdiff(Cells(seu_singlet), Cells(clusters_to_remove))
)
seu_singlet
```

# Rereun normalize after removing CD8 cells from myelo clusters ------------
```{r normalize after removing cd8 from myelo clusters}
seu_singlet <- seu_normalize_var_scale_pca(
  seu_singlet,
  normalize = "sct",
  cluster.name = "cluster.sct",
  run_pca = TRUE,
  pca.reduction.name = "pca.sct",
  umap.reduction.name = "umap.sct",
  dims = 1:30,
  k.param = 20,
  algorithm = 4,
  resolution = 0.5,
  group.singletons = TRUE
)
seu_singlet <- NormalizeData(
  seu_singlet,
  assay = "ADT",
  normalization.method = "CLR"
)
```

```{r viz seu_singlet after removing cd8 from myelo clusters}
viz_quality(seu_singlet,
  assay = "SCT", q_features = t_quality,
  reduction = "umap.sct", gr_by_features = gr_by_features_sct
)

seu_dittoDotPlot(
  seu_singlet,
  vars = vars,
  group.by = "cluster.sct"
)

DefaultAssay(seu_singlet) <- "ADT"
viz_quality(seu_singlet,
  assay = "ADT", q_features = t_adt_quality,
  reduction = "umap.sct", gr_by_features = NULL
)
```


# 06_DSB normalization
Move here from 05_DSB (and create functions which should go to functions.R)

# 07_Remove proteins that do not pass DSB thresholds
remove also isotype-controld
## Strong YES
### Features to remove
```{r}
features_to_remove <- paste0("TotalSeqC-", c(
  "CD279", "CD161", "CD274", "CD152", "CD223", "CD366", "CD357",
  "CD80", "CD86", "CD197", "CD184", "CD335", "CD106", "CD314", "TMEM119",
  "CD137", "CD28",
  "IgG2b-Ctrl", "IgG2a-Ctrl", "IgG-Ctrl", "IgG1-Ctrl"
))
features_to_remove
valid_features <- intersect(features_to_remove, rownames(seu_singlet))
```

### Move counts from adt to adt.dsb.threshold
(ast.dsb.treshold contains only dsb-normalized data)
```{r}
seu_singlet[["ADT.dsb.threshold"]]@counts <- seu_singlet[["ADT"]]@counts
```

### Remove features from both 'counts' and 'data'
```{r}
assay <- seu_singlet[["ADT.dsb.threshold"]]
assay@counts <- assay@counts[!rownames(assay@counts) %in% valid_features, ]
assay@data <- assay@data[!rownames(assay@data) %in% valid_features, ]
assay@meta.features <- assay@meta.features[
  !rownames(assay@meta.features) %in% valid_features,
]
```

### Update the assay in the Seurat object
```{r}
seu_singlet[["ADT.dsb.threshold"]] <- assay
seu_singlet <- Seurat::UpdateSeuratObject(seu_singlet)
```

### Validate
```{r}
dim(seu_singlet[["ADT.dsb.threshold"]])
dim(seu_singlet[["ADT"]])
dim(seu_singlet[["SCT"]])
```

# should I also repeat SCT normalization here after removing adt features?
No, for now, but unsure?


# Export counts from SCT and ADT.dsb.threshold for totalVI
```{r, eval=FALSE}
# seu_singlet
# adata <- convertFormat(
#   seu_singlet,
#   from = "seurat",
#   to = "anndata",
#   main_layer = "counts",
#   # assay = "SCT",
#   assay = "ADT.dsb.threshold",
#   drop_single_values = FALSE,
#   outFile = "seu_singlet_adt_09-jan-25.h5ad"
# )
# adata
```

# After totalVI run, bring back calculated latent
```{r Go to python and bring back latent.csv}
# latent <- read.csv("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/latents/latent-seu_singlet_09-jan-25.csv")

# latent_mtx <- as.matrix(latent)
# rownames(latent_mtx) <- colnames(seu_singlet)
# latent_mtx <- latent_mtx[, -1] # remove 1st col
# dim(latent_mtx)
# colnames(latent_mtx) <- paste0("totalvi_", 1:20)
# colnames(latent_mtx)

# DefaultAssay(seu_singlet) <- "SCT"
# seu_singlet
# colnames(seu_singlet@meta.data)

# seu_singlet[["totalvi.sct"]] <- CreateDimReducObject(
#   embeddings = latent_mtx,
#   key = "totalvi_",
#   assay = DefaultAssay(seu_singlet)
# )
# seu_singlet
# colnames(seu_singlet@meta.data)
```

# Clustering po dodaniu latent
nie normalizuje bo nie trzeba i nie robie pca poniewaz używam totalvi
```{r clustering after adding latent}
# seu_singlet <- seu_normalize_var_scale_pca(
#   seu_singlet,
#   normalize = FALSE,
#   cluster.name = "cluster.totalvi",
#   run_pca = FALSE, # not running pca, changing clusters in totalvi reduction
#   pca.reduction.name = "totalvi.sct", # instead of pca
#   umap.reduction.name = "umap.totalvi.sct",
#   dims = 1:20,
#   k.param = 20,
#   algorithm = 4,
#   resolution = 1.4,
#   group.singletons = FALSE
# )
# Idents(seu_singlet) <- "cluster.totalvi"
```

## Visualize
```{r}
# viz_quality(
#   seu_singlet,
#   assay = "SCT", c(t_quality),
#   reduction = "umap.totalvi.sct", gr_by_features_totalvi
# )
# seu_dittoDotPlot(
#   seu_singlet,
#   vars = t_quality,
#   group.by = "cluster.totalvi"
# )
```
```{r}
# Features(seu_singlet)

# DefaultAssay(seu_singlet) <- "ADT.dsb.threshold"

# viz_quality(
#   seu_singlet,
#   assay = "ADT.dsb.threshold", c(t_adt_quality),
#   reduction = "umap.totalvi.sct", gr_by_features_totalvi
# )
# seu_dittoDotPlot(
#   seu_singlet,
#   vars = t_adt_quality,
#   group.by = "cluster.totalvi"
# )
```

# 18. Vizualize ADT features after all that cleanup
```{r}
# DefaultAssay(seu_singlet) <- "ADT.dsb.threshold"
# features <- get_features(seu_singlet, "ADT.dsb.threshold")
# length(features)
# f1 <- features[1:10]
# f2 <- features[11:21]
# f_list <- list(f1, f2)

# for (i in seq_along(f_list)) {
#   seu_FeaturePlot(
#     seu_singlet, "ADT.dsb.threshold",
#     reduction = "umap.totalvi.sct",
#     color = inferno,
#     features = f_list[[i]],
#     max.cutoff = NA,
#     show = FALSE,
#     save_path = paste0("singleCell_LAB/HitGlio_sample1-test/plots/09-jan-25_sct_dsb-threshold/panel_", i), # nolint
#     ggheight = 20,
#     ggwidth = 20
#   )
# }
```

# Dimplot Final Result
```{r}
DimPlot(
  seu_singlet,
  reduction = "wnn.umap",
  label = TRUE
)
```

# Analyze myeloid clusters
This aims to again subset the main myeloid clusters (C1, C18, C10, C11) + C15, and recluster those cells
## Subset CD45+ clusters
```{r}
DefaultAssay(seu_singlet) <- "SCT"
# Idents(seu_singlet) <- "cluster.totalvi"
Idents(seu_singlet) <- "wsnn_res.0.4"

# seu_singlet_myelo <- subset(seu_singlet, idents = c(1, 10, 11, 18, 15))
seu_singlet_myelo <- subset(
  seu_singlet,
  idents = c(16, 3, 22, 17, 23, 6, 9, 15)
)
DefaultAssay(seu_singlet_myelo) <- "RNA"
seu_singlet_myelo
Idents(seu_singlet_myelo)

seu_singlet_myelo <- seu_normalize_var_scale_pca(
  seu_singlet_myelo,
  normalize = "log",
  cluster.name = "cluster.log.myelo",
  run_pca = TRUE,
  pca.reduction.name = "pca.myelo.log",
  umap.reduction.name = "umap.myelo.pca.log",
  dims = 1:30,
  k.param = 20,
  algorithm = 4,
  # resolution = 0.2,
  resolution = 0.1, # czy jest znaczenie jaką tu res. wybiore? NIE
  group.singletons = FALSE
)
DimPlot(seu_singlet_myelo, reduction = "umap.myelo.pca.log", label = TRUE)

ElbowPlot(seu_singlet_myelo, ndims = 50)
ElbowPlot(seu_singlet_myelo, ndims = 50, reduction = "apca")

# lets see what will happen if I'll do NN again on subset
DefaultAssay(seu_singlet_myelo) <- "ADT.dsb.threshold"

VariableFeatures(seu_singlet_myelo) <- rownames(seu_singlet_myelo)
seu_singlet_myelo <- seu_singlet_myelo %>%
  ScaleData() %>%
  RunPCA(reduction.name = "apca.myelo", verbose = FALSE)

# run WNN
seu_singlet_myelo <- FindMultiModalNeighbors(
  seu_singlet_myelo,
  reduction.list = list("pca.myelo.log", "apca.myelo"),
  dims.list = list(1:30, 1:20),
  k.nn = 30,
  knn.range = 600,
  # dims.list = list(1:30, 1:20),
  modality.weight.name = "RNA.weight",
  verbose = FALSE
)

# resolution <- 0.4
resolution <- 0.9
# cluster
seu_singlet_myelo <- FindClusters(
  seu_singlet_myelo,
  graph.name = "wsnn",
  algorithm = 4,
  resolution = resolution,
  verbose = FALSE,
  random.seed = 1990
)

seu_singlet_myelo <- RunUMAP(
  seu_singlet_myelo,
  nn.name = "weighted.nn",
  reduction.name = "wnn.umap",
  reduction.key = "wnnUMAP_"
)

Idents(seu_singlet_myelo) <- paste0("wsnn_res.", as.character(resolution))
# colnames(seu_singlet_myelo@meta.data)
# Idents(seu_singlet_myelo) <- "wsnn_res.0.4"

# Idents(seu_singlet) <- "cluster.totalvi"

DimPlot(
  seu_singlet_myelo,
  reduction = "wnn.umap",
  # group.by = "MULTI_ID",
  label = TRUE
)

table(seu_singlet_myelo@active.ident)

# for now remove clusters 13, 14, 15 as they have 41, 40 and 5 cells
# seu_singlet_myelo <- subset(seu_singlet_myelo, idents = c(1:12)) # remove
# seu_singlet_myelo <- subset(seu_singlet_myelo, idents = c(1:14)) # remove
# seu_singlet_myelo <- subset(seu_singlet_myelo, idents = c(1:11)) # remove

# table(seu_singlet_myelo@active.ident)

# evaluate clustering
# dist.matrix <- dist(x = Embeddings(object = seu_singlet_myelo[["pca"]])[, 1:30])
# dist.matrix <- dist(x = Embeddings(object = seu_singlet_myelo[["pca.myelo.log"]]))
# dist.matrix <- dist(x = Embeddings(object = seu_singlet_myelo[["apca"]]))

colnames(seu_singlet_myelo@meta.data)

graph_adj <- as.matrix(seu_singlet_myelo@graphs$wsnn) # Weighted SNN graph
dist_snn <- as.dist(1 - graph_adj)

# dist.matrix <- dist(Embeddings(seu_singlet_myelo[["wnn.umap"]]))
sil <- silhouette(
  as.numeric(as.character(seu_singlet_myelo@meta.data$wsnn_res.0.9)),
  dist = dist_snn
)
# sil <- silhouette(
# as.numeric(as.character(seu_singlet_myelo@meta.data$cluster.log.myelo)), dist=dist.matrix
# )

head(sil)
mean(sil[, 3])

cluster_sil_scores <- aggregate(sil[, 3], by = list(sil[, 1]), mean)
cluster_sil_scores




saveRDS(seu_singlet_myelo, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/10-Feb-2025_seu_singlet_myelo_silhouette.rds")

saveRDS(seu_singlet_myelo, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/07-Feb-2025_seu_singlet_myelo_res.0.5.rds")
# go to create vizuals
```

## remove cluster 11, it has only 81 cells (it is probably redundant) CHECK THIS!
```{r}
# table(seu_singlet_myelo@active.ident)

# Idents(seu_singlet_myelo) <- "cluster.sct.myelo"

# seu_singlet_myelo <- subset(seu_singlet_myelo, idents = c(1:10)) # remove C11

# table(seu_singlet_myelo@active.ident)

# 10 clusters, not-normalized after subsetting
saveRDS(seu_singlet_myelo, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/04-Febb-2025-seu_singlet_myelo") # nolint
```

# Analyze tumor cluster
```{r}
DefaultAssay(seu_singlet) <- "SCT"
Idents(seu_singlet) <- "wsnn_res.0.4"
DimPlot(
  seu_singlet,
  reduction = "wnn.umap",
  label = TRUE
)

seu_singlet_tumor <- subset(seu_singlet, idents = c(14, 10))

# tu chyba nie ma sensu, żeby robić wnn z ADT?

DefaultAssay(seu_singlet_tumor) <- "SCT"
seu_singlet_tumor
Idents(seu_singlet_tumor)

seu_singlet_tumor <- seu_normalize_var_scale_pca(
  seu_singlet_tumor,
  normalize = "log",
  cluster.name = "cluster.log.tumor",
  run_pca = TRUE,
  pca.reduction.name = "pca.tumor.log",
  umap.reduction.name = "umap.tumor.pca.log",
  dims = 1:30,
  k.param = 30,
  algorithm = 4,
  resolution = 0.7,
  group.singletons = TRUE
)

DimPlot(
  seu_singlet_tumor,
  reduction = "umap.tumor.pca.log",
  label = TRUE
)
FeaturePlot(
  seu_singlet_tumor,
  features = "Cellcycle",
  reduction = "umap.tumor.pca.log"
)


colnames(seu_singlet_tumor@meta.data)
DimPlot(seu_singlet_tumor,
  group.by = "MULTI_ID",
  reduction = "umap.tumor.pca.log",
  label = TRUE
)

dist.matrix <- dist(
  x = Embeddings(object = seu_singlet_tumor[["pca.tumor.log"]])[, 1:5]
)
sil <- silhouette(
  as.numeric(as.character(seu_singlet_tumor@meta.data$cluster.log.tumor)),
  dist = dist.matrix
)

head(sil)
mean(sil[, 3])

cluster_sil_scores <- aggregate(sil[, 3], by = list(sil[, 1]), mean)
cluster_sil_scores




saveRDS(seu_singlet_tumor, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/30-Jan-2025-sue_singlet_tumor") # nolint
```

# additional (may be removed later)
## check if you subset cluster 20 with myelo clusters, will it cluster together or not

```{r}
DefaultAssay(seu_singlet) <- "SCT"
Idents(seu_singlet) <- "cluster.totalvi"

seu_singlet_myelo2 <- subset(seu_singlet, idents = c(1, 10, 11, 18, 15, 20))
DefaultAssay(seu_singlet_myelo2) <- "SCT"
seu_singlet_myelo2
Idents(seu_singlet_myelo2)

seu_singlet_myelo2 <- seu_normalize_var_scale_pca(
  seu_singlet_myelo2,
  normalize = "sct",
  cluster.name = "cluster.sct.myelo",
  run_pca = TRUE,
  pca.reduction.name = "pca.myelo.sct",
  umap.reduction.name = "umap.myelo.pca.sct",
  dims = 1:30,
  k.param = 30,
  algorithm = 4,
  resolution = 1.0,
  group.singletons = FALSE
)
Idents(seu_singlet_myelo2) <- "cluster.totalvi"
DimPlot(seu_singlet_myelo2, reduction = "umap.myelo.pca.sct", label = TRUE)
```

```{r clustering after adding latent}
seu_singlet <- seu_normalize_var_scale_pca(
  seu_singlet,
  normalize = "sct",
  cluster.name = "cluster.sct.test",
  run_pca = TRUE, # not running pca, changing clusters in totalvi reduction
  pca.reduction.name = "pca.sct.test", # instead of pca
  umap.reduction.name = "umap.pca.test",
  dims = 1:30,
  k.param = 30,
  algorithm = 4,
  resolution = 0.6,
  group.singletons = FALSE
)
Idents(seu_singlet) <- "cluster.totalvi"
DimPlot(seu_singlet, reduction = "umap.totalvi.sct", label = TRUE)
```

# MultiModal with SCT and TOTALVI (testowo)
```{r}
seu_singlet <- FindMultiModalNeighbors(
  seu_singlet,
  reduction.list = list("pca.sct.test", "totalvi.sct"),
  dims.list = list(1:30, 1:20), modality.weight.name = "RNA.weight"
)

seu_singlet <- RunUMAP(
  seu_singlet,
  nn.name = "weighted.nn",
  reduction.name = "wnn.umap",
  reduction.key = "wnnUMAP_"
)

seu_singlet <- FindClusters(
  seu_singlet,
  graph.name = "wsnn",
  algorithm = 4,
  resolution = 0.3,
  verbose = FALSE
)

# Idents(seu_singlet) <- "cluster.totalvi"
colnames(seu_singlet@meta.data)
Idents(seu_singlet) <- "wsnn_res.0.3"

DimPlot(
  seu_singlet,
  reduction = "wnn.umap",
  group.by = "MULTI_ID",
  label = TRUE
)

viz_quality(
  seu_singlet,
  assay = "SCT", c(t_quality),
  reduction = "umap.pca.test", gr_by_features_totalvi
)
```


# MultiModal with SCT and ADT DSB threshold
```{r}
seu_singlet <- readRDS("17-jan-2025_seu_singlet.rds")
seu_singlet

# set up dsb values to use in WNN analysis (do not normalize with CLR, use dsb normalized values)
DefaultAssay(seu_singlet) <- "ADT.dsb.threshold"



features <- get_features(seu_singlet, "ADT.dsb.threshold")
# cluster with adt data only
# cluster and run umap
seu_singlet <- FindNeighbors(
  seu_singlet,
  features = features,
  dims = NULL, assay = "ADT.dsb.threshold",
  k.param = 30,
  verbose = FALSE
)

# direct graph clustering
seu_singlet <- FindClusters(
  seu_singlet,
  resolution = 1,
  algorithm = 3,
  graph.name = "ADT.dsb.threshold_snn",
  verbose = FALSE
)
seu_singlet <- RunUMAP(
  seu_singlet,
  features = features,
  assay = "ADT.dsb.threshold"
)
seu_singlet

DimPlot(seu_singlet, label = TRUE)

f1 <- features[1:10]
f2 <- features[11:21]

FeaturePlot(
  seu_singlet,
  features = f2
)

d <- cbind(
  seu_singlet@meta.data,
  as.data.frame(t(seu_singlet@assays$ADT.dsb.threshold@data))
  # s@reductions$umap@cell.embeddings)
)

adt_plot <- d %>%
  dplyr::group_by(ADT.dsb.threshold_snn_res.1) %>%
  dplyr::summarize_at(.vars = features, .funs = median) %>%
  tibble::remove_rownames() %>%
  tibble::column_to_rownames("ADT.dsb.threshold_snn_res.1")
# plot a heatmap of the average dsb normalized values for each cluster
pheatmap::pheatmap(t(adt_plot),
  color = viridis::viridis(25, option = "B"),
  fontsize_row = 8, border_color = NA
)


VariableFeatures(seu_singlet) <- rownames(seu_singlet)
seu_singlet <- seu_singlet %>%
  ScaleData() %>%
  RunPCA(reduction.name = "apca", verbose = FALSE)


# run WNN
seu_singlet <- FindMultiModalNeighbors(
  seu_singlet,
  reduction.list = list("pca.sct", "apca"),
  dims.list = list(1:30, 1:18),
  modality.weight.name = "RNA.weight",
  verbose = FALSE
)

# cluster
seu_singlet <- FindClusters(seu_singlet,
  graph.name = "wsnn",
  algorithm = 4,
  resolution = 0.4,
  verbose = FALSE,
  random.seed = 1990
)

seu_singlet <- RunUMAP(
  seu_singlet,
  nn.name = "weighted.nn",
  reduction.name = "wnn.umap",
  reduction.key = "wnnUMAP_"
)

colnames(seu_singlet@meta.data)
Idents(seu_singlet) <- "wsnn_res.0.4"
# Idents(seu_singlet) <- "cluster.totalvi"

DimPlot(
  seu_singlet,
  reduction = "wnn.umap",
  # group.by = "MULTI_ID",
  label = TRUE
)

DimPlot(
  seu_singlet,
  reduction = "umap.totalvi.sct",
  group.by = "MULTI_ID",
  label = TRUE
)

seu_singlet
FeaturePlot(
  seu_singlet,
  reduction = "wnn.umap",
  features = f2
)


FeatureScatter(
  seu_singlet,
  "TotalSeqC-CD45",
  "TotalSeqC-CD8"
)








viz_quality(
  seu_singlet,
  assay = "SCT", c(t_quality),
  reduction = "wnn.umap", gr_by_features_totalvi
)

DefaultAssay(seu_singlet) <- "ADT.dsb.threshold"
features <- get_features(seu_singlet, "ADT.dsb.threshold")
length(features)
f1 <- features[1:10]
f2 <- features[11:21]
f_list <- list(f1, f2)

for (i in seq_along(f_list)) {
  seu_FeaturePlot(
    seu_singlet, "ADT.dsb.threshold",
    reduction = "wnn.umap",
    color = inferno,
    features = f_list[[i]],
    max.cutoff = NA,
    show = FALSE,
    save_path = paste0("singleCell_LAB/HitGlio_sample1-test/plots/04-feb-25_sct_dsb-threshold/panel_", i), # nolint
    ggheight = 20,
    ggwidth = 20
  )
}
```


# PRZENOSZE PONIŻSZE DO 02_Create_vizuals.Rmd

# Heatmap of top 5 genes in all clusters
# zastąpiąne lepszym pojeściem!
# ```{r}
# top_genes <- Seurat::FindAllMarkers(
#   seu_singlet_myelo,
#   test_use = "MAST", only.pos = TRUE
# ) |>
#   group_by(cluster) |>
#   top_n(n = 5, wt = avg_log2FC)

# DoHeatmap(seu_singlet_myelo, features = unique(top_genes$gene)) +
#   scale_fill_viridis_c()
# ```

## Transfer labels from GBM-citeseq

## Transfer labels from XXX

## Find Marker genes
# też trzeba zastąpić lepszym podejściem? Nie wiem teraz.
```{r}
DefaultAssay(seu_singlet_myelo) <- "SCT"
markers <- FindMarkers(
  seu_singlet_myelo,
  ident.1 = "8",
  # ident.2 = "5",
  test_use = "MAST",
  min.pct = 0.25,
  # min.diff.pct = 0.5 # main heatmap
  min.diff.pct = 0.1
) |>
  arrange(desc(avg_log2FC))

dim(markers)
markers[1:20, ]
rownames(markers[1:20, ])

"VIM" %in% rownames(markers)

seu_singlet_myelo <- ScaleData(
  seu_singlet_myelo,
  features = as.character(unique(rownames(markers)), assay = "SCT")
)

DoHeatmap(seu_singlet_myelo, features = rownames(markers), slot = "scale.data") + scale_fill_viridis_c()
```

# make volcanos
```{r}
library(ggrepel)

markers$highlight <- ifelse(
  rownames(markers) %in% rownames(markers[1:20, ]), rownames(markers), NA
)
markers$color <- ifelse(
  rownames(markers) %in% rownames(markers[1:20, ]), "yes", "no"
)

head(markers)


ggplot(markers, aes(x = avg_log2FC, y = -log10(p_val_adj), color = color)) +
  geom_point(alpha = 0.8) +
  scale_color_manual(values = c("gray", "red")) +
  labs(title = "Volcano Plot", x = "Log2 Fold Change", y = "-Log10 Adjusted P-value") +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    axis.text = element_text(size = 14)
  ) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") + # p-value threshold
  # geom_vline(xintercept = c(-0.25, 0.25), linetype = "dashed", color = "blue") + # logFC threshold
  geom_text_repel(aes(label = highlight), na.rm = TRUE, size = 4) # Label specific genes
```

```{r}
DefaultAssay(seu_singlet) <- "SCT"
seu_singlet
FeaturePlot(
  seu_singlet_myelo,
  reduction = "umap.myelo.pca.sct",
  # features = c("FCN1", "VCAN") # clas. monocytes
  # features = c("C1QA"), # tams

  # features = c("EREG", "MT2A", "MT1G"),
  # features = c("HK2", "ENO2", "SLC3A1"),
  # features = c("CD44", "VCAN", "GPNMB")
  # features = c("CD14", "MARCO", "CD163")
  # features = c("CCL2", "CXCL8")
  # features = c("STAT3", "NFKB1")
  # features = c("ANPEP", "CD33")
  # features <- c("CCR7", "CD45RA", "CD209", "CLEC4C", "LILRB4", "NRP1", "B220", "SiglecH", "IFN-α")
  # features  = c("S100A8", "S100A9")
  # features  = c("KLF4", "AXL", "CLEC10A", "SCT")
  # features  = c("TGFBI", "P2RY12")
  features  = c("HMOX1")
  # features = "CXCR4"
  # features = c("C1QA", "IGF1") # mature macrophage
  # features = c("C1QA", "STMN1", "MKI67") # prolif. tams
  # features = c("C1QA", "TGFBI", "CLEC12A", "FXYD5") # mo-TAM
  # features = c("C1QA", "SALL1", "TMEM119", "P2RY12")
  # features = c("C1QA", "TMIGD3", "APOC2", "SCIN")
  # features = c("C1QA", "IGF1", "EREG", "S100A6", "LYZ") # monocytes/Mo-TAM
  # features = c("C1QA", "GPNMB", "LGALS3", "FABP5") # phagocytosis/lipid metab.
  # features = c("C1QA", "BNIP3", "ADAM8", "MIF", "SLC2A1")
  # features = c("P2RY12") # high in microglia, but not here
  # features = c("HLA-A", "HLA-B")
  # features = c("TREM2", "APOE", "P2RY12", "TMEM119")
  # features = "CD14",
  # features = c("PLAC8", "CST7", "SH3BP4", "LGALS2")
  # features = c("CXCR1", "TMEM119", "P2YR12")
  # features = mg_tam
  # features = c("ID1", "ID2", "ID3", "ETS2")
  # features = c("MRC1", "Ly6C")
  # features = "CXCL12"
  # features = c("CXCR4", "CXCR7")
  # features = c("FCN1", "CD14") # cd16 mono
  # features = c("GZMB", "IL3RA", "COBLL1", "TCF4") # pDC
) + patchwork::plot_annotation("")

mc_b <- c("HEXB", "TMEM119", "P2RY12")
microglia_ps <- c("CX3CR1", "C1QA", "FCGR1A", "OLFML3", "GPR34")
macrophage_ps <- c("CD14", "ITGA4", "CCR2", "IFITM2")
hypoxia_ps <- c("PLIN3", "TIMP1", "VIM", "BNIP3")
```

```{r}
stress <- c("HSP90", "JUN", "FOS")
microglia <- c("TMEM119", "P2RY12", "CX3CR1", "P2RY13", "SELPLG", "CSF1R", "TREM2", "CCR5", "MARCKS", "CCR2")
mg_tam <- c("P2RY12", "CX3CR1", "FCGR1A", "CH25H", "CCL4L2")
mo_tam <- c("TGFBI", "CD14", "CD163", "SELENOP", "GPNMB")
mo <- c("FCN1", "VCAN", "CD52", "S100A8", "S100A9")
ifn_tam <- c("IFIT1", "IFI44L", "IFIT3", "IFI6", "IFI44", "FGL2", "HERC5", "IFIT2", "ISG15", "CXCL10", "MX1", "MX2")
prolif_tam <- c("MKI67", "STMN1", "TYMS", "TOP2A", "TUBB")
lipid_tam <- c("APOC1", "APOE", "CD63", "LGALS3", "ACP5", "GCHFR", "OTOA", "PLA2G7", "SDS")
hypoxic_tam <- c("ENO1", "SCD", "PLP2", "RAB42", "S100A10", "S100A6", "HK2", "SLC2A1", "CXCL8", "LGALS1", "TIMP1", "PLIN2", "CTSL", "LDHA", "NDRG1", "HILPDA", "ERO1A", "NUPR1", "MT2A")
chemotaxis_tam <- c("SPP1", "RGS16", "FSCN1", "HAMP", "BIN1", "IBSP")

# chat
hypoxia_markers <- c(
  "GLUT1", "HK2", "LDHA", "PFKFB3", "VEGFA", "ANGPTL4",
  "ADM", "BNIP3", "EGLN1", "CA9", "NDRG1", "CD274", "TGF-β1",
  "S100A8", "S100A9", "MMP2", "MMP9", "LOX", "TIMP1", "SOD2",
  "PRDX1", "PRDX2", "HMOX1", "ARG1", "NOS2", "MRC1", "HIF1A",
  "HIF2A", "PGK1", "ENO1", "CXCR4"
)
pDC_genes <- c("CLEC4C", "LILRA4", "IRF7", "TCF4", "NRP1", "IL3RA", "FCER1A")
moDC_genes <- c("FCN1", "S100A8", "S100A9", "CD14", "CD1C", "CCR2", "FCGR3A")
cDC2_genes <- c("CD1C", "CLEC10A", "IRF4", "CD209", "FCER1A")
cDC1_genes <- c("CLEC9A", "XCR1", "IRF8", "BATF3", "IDO1", "FLT3")
langerhans_genes <- c("CD207", "EPCAM", "HLA-DQ")


MCG <- c("HOMER1", "CCL2", "NR4A3", "P2RY12", "CX3CR1", "VSIG4", "SPP1", "TREM2")


# tumor
outer_radial_glia <- c("HOPX", "PTPRZ1", "TNC", "FAM107A")
```

```{r}
features <- hypoxia_ps
features <- c("S100A9", "VCAN", "LYZ") # monocyte precursor
features <- c("FCGR3A", "C1QA", "CX3CR1") # non-classical monocytes


# features = c("FCN1", "VCAN"),
# features = c("HLA-DPB1", "HLA-DQA1", "HLA-DRA", "HLA-DPA1"),
# features = c("CCL3L3", "CCL4L2", "CCL3", "CCL4", "CCL2")
# features_2 = c("EGR1", "EGR2")
# features <- c("PLIN2", "TIMP1", "VIM", "BNIP3")
# features <- c("IRF4", "IRF7", "IRF8") # pDC TFs
# features <- c("IRF4", "KLF4", "ZBTB46") # moDC TFs
features <- c("CCR7", "CD45RA", "CD209", "CLEC4C", "LILRB4", "NRP1", "B220", "SiglecH", "IFNA")


seu_singlet_myelo <- AddModuleScore(
  seu_singlet_myelo,
  features = features,
  pool = NULL,
  nbin = 24,
  ctrl = 100,
  k = FALSE,
  assay = NULL,
  name = "Cluster",
  seed = 1,
  search = FALSE,
  slot = "data",
)

FeaturePlot(
  seu_singlet_myelo,
  features = "Cluster1",
  reduction = "umap.myelo.pca.sct",
  label = TRUE
) & mycolor2

VlnPlot(
  seu_singlet_myelo,
  features = features,
  assay = "SCT"
)

DoHeatmap(seu_singlet_myelo, features = features, slot = "scale.data") +
  scale_fill_viridis_c()
```

```{r}
top_genes <- Seurat::FindAllMarkers(
  seu_singlet_myelo,
  test_use = "MAST", only.pos = TRUE
) |>
  group_by(cluster) |>
  top_n(n = 10, wt = avg_log2FC)

DoHeatmap(seu_singlet_myelo, features = top_genes$gene, slot = "scale.data") +
  scale_fill_viridis_c()
```
?DoHeatmap

```{r}
DefaultAssay(seu_singlet_myelo) <- "ADT.dsb.threshold"
FeaturePlot(
  seu_singlet_myelo,
  reduction = "umap.myelo.pca.sct",
  label = TRUE,
  features = "TotalSeqC-CD11b"
)
```

# Vizualize ADT features in isolated myeloid clusters
```{r}
DefaultAssay(seu_singlet_myelo) <- "ADT.dsb.threshold"
features <- get_features(seu_singlet_myelo, "ADT.dsb.threshold")
length(features)
f1 <- features[1:10]
f2 <- features[11:21]
f_list <- list(f1, f2)

for (i in seq_along(f_list)) {
  seu_FeaturePlot(
    seu_singlet_myelo, "ADT.dsb.threshold",
    reduction = "umap.myelo.pca.sct",
    color = inferno,
    features = f_list[[i]],
    max.cutoff = NA,
    show = FALSE,
    save_path = paste0("singleCell_LAB/HitGlio_sample1-test/plots/21-Jan-25_sct_dsb-threshold_myeloidOnly/panel_", i), # nolint
    ggheight = 20,
    ggwidth = 20
  )
}
```



# Inne podejście :DDD (lepsza heatmapa ogólna)



#  heatmapy subsetów (lepsze podejście, FindAllMarkers nie FindMarkers)
```{r}
# subset_object <- subset(seu_singlet_myelo, idents = c("5", "8"))
```

```{r}
# table(subset_object@active.ident)
```

```{r}
# Compute differentiall expression
markers_genes <- FindMarkers(
  seu_singlet_myelo,
  ident.1 = "5",
  ident.2 = "8",
  log2FC.threshold = 0.2,
  test.use = "MAST",
  min.pct = 0.1,
  min.diff.pct = 0.2,
  only.pos = TRUE,
  max.cells.per.ident = 50,
  assay = "SCT"
)
```

```{r}
top15 <- markers_genes %>%
  # group_by(cluster) %>%
  top_n(-15, p_val_adj)
head(top15)
```

```{r}
# create a scale.data slot for the selected genes
subset_object <- ScaleData(
  seu_singlet_myelo,
  features = as.character(unique(top15$gene)), assay = "SCT"
)

subset_object <- subset(seu_singlet_myelo, idents = c("5", "8"))

DoHeatmap(
  subset_object,
  features = as.character(unique(rownames(top15))),
  assay = "SCT"
)
```

```{r}
DotPlot(
  seu_singlet_myelo,
  features = rev(as.character(unique(top5$gene))), group.by = "cluster.sct.myelo", assay = "SCT"
) + coord_flip()
```

```{r}
head(markers_genes)

top15_cluster <- top15 |>
  filter(cluster == 8)

top15_cluster$gene
```

## GSVA



# create PCA to infer microgllia/macrophages 
```{r}
Idents(seu_singlet_myelo) <- "cluster.sct.myelo"
seu_singlet_macmg <- subset(seu_singlet_myelo, idents = c(1, 2, 3, 4))

seu_singlet_macmg <- NormalizeData(seu_singlet_macmg)
seu_singlet_macmg <- ScaleData(seu_singlet_macmg)
seu_singlet_macmg <- RunPCA(seu_singlet_macmg)

# Get PCA feature loadings
pca_loadings <- seu_singlet_macmg[["pca"]]@feature.loadings

# Get positive loadings (top genes contributing positively)
top_pos_genes <- sort(pca_loadings[, 4], decreasing = TRUE)[1:50]
print(names(top_pos_genes))

# Get negative loadings (top genes contributing negatively)
top_neg_genes <- sort(pca_loadings[, 4], decreasing = FALSE)[1:50]
print(names(top_neg_genes))

top_pos_neg <- list(
  "positive" = names(top_pos_genes),
  "negative" = names(top_neg_genes)
)

auc_scores <- AUCell_calcAUC(
  top_pos_neg,
  gene_rankings
)
gene_rankings <- AUCell_buildRankings(expr_matrix, plotStats = FALSE)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_myelo <- AddMetaData(seu_singlet_myelo, metadata = auc_matrix)

VlnPlot(
  seu_singlet_myelo,
  features = c(
    "positive",
    "negative"
  )
)

FeaturePlot(
  seu_singlet_myelo,
  features = c(
    "positive",
    "negative"
  ),
  reduction = "umap.myelo.pca.sct"
) & mycolor2
```
















