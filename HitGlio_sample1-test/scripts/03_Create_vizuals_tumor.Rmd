---
title: "HIT-GLIO sample1 tumor clusters annotation"
author: "MF"
date: "`r Sys.Date()`"
# output: powerpoint_presentation
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: true
      number_sections: true
---


```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(ggplot2)
  library(Matrix)
  library(tidyverse)
  library(clustree)
  library(reticulate) # load packages required by leiden algo
  reticulate::use_condaenv("/mnt/sda4/conda/envs/R")
  library(viridis) # colors
  options(future.globals.maxSize = 3.0 * 1e9) # 3GB
  library(dittoSeq)
  library(AUCell)
  library(GSVA)
  library(msigdbr)
  library(Nebulosa)
  library(monocle3)
  library(SeuratExtend)
  # library(escape)
  library(fgsea)
  library(DT)
})
```

```{r}
seu_singlet_tumor <- readRDS("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/30-Jan-2025-sue_singlet_tumor") # nolint

source("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/scripts/functions.R")
source("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/scripts/00_Global_vars.R")
source("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/scripts/cell_features.R")

set.seed(123)
```

# Azimuth
nie wiem czy jest sens, raczej nie
```{r, eval=FALSE}
library(Azimuth)
library(SeuratDisk)
library(SeuratData)

seu_singlet_azi <- RunAzimuth(seu_singlet_tumor, reference = "humancortexref")
colnames(seu_singlet_azi@meta.data)

seu_singlet_azi <- NormalizeData(seu_singlet_azi)
Idents(seu_singlet_azi) <- "predicted.class"

seu_DimPlot(
  seu_singlet_azi,
  reduction = "umap.tumor.pca.log",
  group.by = c("predicted.subclass"),
  show = TRUE,
  ggheight = NA,
  ggwidth = NA
)
```

# Diff.Expr. Cluster X vs REST
Make lognorm for RNA assay. Subset 100 cells.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
DefaultAssay(seu_singlet_tumor) <- "RNA"
```

## subset even number of cells
```{r, echo=FALSE, message=FALSE, warning=FALSE}
table(seu_singlet_tumor@active.ident)

cluster_ids <- Idents(seu_singlet_tumor)

# Initialize an empty list to store the subsetted cells
subset_cells <- list()

# Loop through each cluster and sample cells
for (cluster in unique(cluster_ids)) {
  cells_in_cluster <- WhichCells(seu_singlet_tumor, idents = cluster)
  sampled_cells <- sample(cells_in_cluster, size = 40)
  # size = min(100, length(cells_in_cluster)) # if no of cell smaller than specified, select max cells in cluster # nolint
  subset_cells[[cluster]] <- sampled_cells
}

# Combine the sampled cells into a single vector
subset_cells_all <- unlist(subset_cells)

# Subset the Seurat object
seurat_subset <- subset(seu_singlet_tumor, cells = subset_cells_all)
seurat_subset

seurat_subset <- NormalizeData(seurat_subset)
seurat_subset <- ScaleData(seurat_subset)

table(seurat_subset@active.ident)
```

## Compute differentiall expression
```{r, echo=FALSE, message=FALSE, warning=FALSE}
markers_genes <- FindAllMarkers(
  seurat_subset,
  log2FC.threshold = 0.2,
  test.use = "MAST",
  min.pct = 0.1,
  min.diff.pct = 0.2,
  only.pos = TRUE,
  # max.cells.per.ident = 50, this subsamples randomly every time, better to subsample on your own. # nolint
  assay = "RNA"
)
```

## draw barlopts with top25
```{r}
top25 <- markers_genes %>%
  group_by(cluster) %>%
  top_n(-25, p_val_adj)
```

```{r}
for (i in unique(top25$cluster)) {
  # print genes protted on barplots (top25 genes in each cluster)
  omg <- top25 |>
    filter(cluster == i)
  print(omg$gene)


  barplot(
    sort(setNames(top25$avg_log2FC, top25$gene)[top25$cluster == i], FALSE),
    horiz = TRUE,
    las = 1,
    main = paste0(i, " vs. rest"),
    border = "white",
    yaxs = "i"
  )
  abline(v = c(0, 0.25), lty = c(1, 2))
}
```

## make heatmap with top genes
```{r, fig.width=10, fig.height=12}
top_x <- markers_genes %>%
  group_by(cluster) %>%
  slice_min(p_val_adj, n = 10, with_ties = FALSE)

seurat_subset_heatmap <- seurat_subset

seurat_subset_heatmap <- ScaleData(
  seurat_subset_heatmap,
  features = as.character(unique(top_x$gene)), assay = "RNA"
)

DoHeatmap(
  seurat_subset_heatmap,
  features = as.character(unique(top_x$gene)),
  group.by = "cluster.log.tumor", assay = "RNA"
)
```

## make dotplot with top 10 (same viz. as heatmap)
```{r, fig.width=10, fig.height=15}
DotPlot(
  seurat_subset_heatmap,
  features = rev(as.character(unique(top_x$gene))), group.by = "cluster.sct.tumor", assay = "RNA"
) + coord_flip() + mycolor2
```

## validate top10 gene expression on vlnplots
```{r, fig.width=12, fig.height=9}
for (i in unique(top_x$cluster)) {
  top_x_cluster <- top_x |>
    filter(cluster == i)

  print(paste0("cluster: ", i))

  print(VlnPlot(
    seu_singlet_tumor,
    features = top_x_cluster$gene
  ) + patchwork::plot_annotation(
    paste0("Cluster ", i, " top genes"),
    theme = theme(plot.title = element_text(size = 25))
  ))
}
```

# Generate scores of marker gene sets using AUCell
## Run AUCEll
```{r, echo = FALSE, warning=FALSE}
expr_matrix <- as.matrix(
  GetAssayData(seu_singlet_tumor, layer = "data", assay = "RNA")
)

gene_rankings <- AUCell_buildRankings(expr_matrix, plotStats = FALSE)
```

### Liu2022 pHGG metapropgrams
```{r}
print(liu2022)

auc_scores <- AUCell_calcAUC(
  liu2022,
  gene_rankings
)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_tumor <- AddMetaData(seu_singlet_tumor, metadata = auc_matrix)

images <- map(
  names(liu2022),
  ~ FeaturePlot(
    seu_singlet_tumor,
    features = .x,
    pt.size = 1,
    label = TRUE,
    reduction = "umap.tumor.pca.log"
  ) & mycolor2 & NoAxes()
)

stacked_images <- patchwork::wrap_plots(images, ncol = 3)
plot1 <- stacked_images + patchwork::plot_annotation(
  title = "AUCell scores of Liu2022 The Landscape of Tumor Cell States and Spatial Organization in H3-K27M Mutant Diffuse Midline Glioma",
  theme = theme(plot.title = element_text(size = 25))
)
print(plot1)
```

### Hara2021 pHGG metapropgrams
```{r}
print(hara2021)

auc_scores <- AUCell_calcAUC(
  hara2021,
  gene_rankings
)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_tumor <- AddMetaData(seu_singlet_tumor, metadata = auc_matrix)

images <- map(
  names(hara2021),
  ~ FeaturePlot(
    seu_singlet_tumor,
    features = .x,
    pt.size = 1,
    label = TRUE,
    reduction = "umap.tumor.pca.log"
  ) & mycolor2 & NoAxes()
)

stacked_images <- patchwork::wrap_plots(images, ncol = 3)
plot1 <- stacked_images + patchwork::plot_annotation(
  title = "AUCell scores of Hara2021 Interactions between cancer cells and immune cells drive transitions",
  theme = theme(plot.title = element_text(size = 25))
)
print(plot1)
```

### Nefter2019 metapropgrams
```{r}
neftel2019 <- read_csv("/mnt/sda4/marker_genes/neftel2019.csv")

print(neftel2019)

auc_scores <- AUCell_calcAUC(
  neftel2019,
  gene_rankings
)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_tumor <- AddMetaData(seu_singlet_tumor, metadata = auc_matrix)

images <- map(
  names(neftel2019),
  ~ FeaturePlot(
    seu_singlet_tumor,
    features = .x,
    pt.size = 1,
    label = TRUE,
    reduction = "umap.tumor.pca.log"
  ) & mycolor2 & NoAxes()
)

stacked_images <- patchwork::wrap_plots(images, ncol = 3)
plot1 <- stacked_images + patchwork::plot_annotation(
  title = "AUCell scores of Neftel2019",
  theme = theme(plot.title = element_text(size = 25))
)
print(plot1)
```

### Filbin2018 metapropgrams
```{r}
filbin2018 <- read_csv("/mnt/sda4/marker_genes/filbin2018.csv")

print(filbin2018)

auc_scores <- AUCell_calcAUC(
  filbin2018,
  gene_rankings
)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_tumor <- AddMetaData(seu_singlet_tumor, metadata = auc_matrix)

images <- map(
  names(filbin2018),
  ~ FeaturePlot(
    seu_singlet_tumor,
    features = .x,
    pt.size = 1,
    label = TRUE,
    reduction = "umap.tumor.pca.log"
  ) & mycolor2 & NoAxes()
)

stacked_images <- patchwork::wrap_plots(images, ncol = 3)
plot1 <- stacked_images + patchwork::plot_annotation(
  title = "AUCell scores of Filbin2018",
  theme = theme(plot.title = element_text(size = 25))
)
print(plot1)
```

# Pathway analysis
## GSVA (GSVA using gsva package)
The GSVA package provides an implementation of this approach for the following methods:
* gsva (HÃ¤nzelmann, Castelo, and Guinney 2013). This is the default method of the package and similarly to ssGSEA, is a non-parametric method that uses the empirical CDFs of gene expression ranks inside and outside the gene set, but it starts by calculating an expression-level statistic that brings gene expression profiles with different dynamic ranges to a common scale.
### GSVA msigdb Hallmark collection = 0 DE pathways
```{r, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "H",
  gsva_type = "gsva"
)
# as it is 0 pathways here, code for calculating and  plotting is removed
```

```{r}
gsva_cx <- "GSVA_H"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = "GSVA_H",
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "GSVA top 40(20up+20down) DE (wilcox) Hallmark pathways in Cluster "
)
```

### GSVA msgidb C2 collection
```{r, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "C2",
  gsva_type = "gsva"
)

saveRDS(gsva_es, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/25-Feb-25_gsva_es_tumor_C2.rds") # nolint
```

```{r, echo=FALSE, warning=FALSE}
# as gsva for C2 takes time, save and load .rds with gsva calculated
gsva_es <- readRDS("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/25-Feb-25_gsva_es_tumor_C2.rds") # nolint

gsva_cx <- "GSVA_C2"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = "GSVA_C2",
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "GSVA top 40(20up+20down) DE (wilcox) C2 pathways in Cluster "
)
```

## zscore method (using gsva package)
### zscore msigdb Hallmark collection
```{r, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "H",
  gsva_type = "zscore"
)
```

```{r, echo=FALSE, warning=FALSE}
# as gsva for C2 takes time, save and load .rds with gsva calculated
gsva_cx <- "GSVA_H_zscore"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = gsva_cx,
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "zscoreGSVA top 40(20up+20down) DE (wilcox) Hallmark pathways in Cluster "
)
```

### zscore msigdb C2 collection
```{r, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "C2",
  gsva_type = "zscore"
)
```

```{r, echo=FALSE, warning=FALSE}
gsva_cx <- "GSVA_C2_zscore"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = gsva_cx,
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "zscoreGSVA top 40(20up+20down) DE (wilcox) Hallmark pathways in Cluster "
)
```

## PLAGE (using GSVA package)
*plage (Tomfohr, Lu, and Kepler 2005). Pathway level analysis of gene expression (PLAGE) standardizes expression profiles over the samples and then, for each gene set, it performs a singular value decomposition (SVD) over its genes. The coefficients of the first right-singular vector are returned as the estimates of pathway activity over the samples. Note that, because of how SVD is calculated, the sign of its singular vectors is arbitrary.

## PLAGE msigdb Hallmark 
```{r, eval=TRUE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "H",
  gsva_type = "plage"
)
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
# as gsva for C2 takes time, save and load .rds with gsva calculated
gsva_cx <- "GSVA_H_plage"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=TRUE, echo=FALSE, warning=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = gsva_cx,
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, eval=TRUE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "plageGSVA top 40(20up+20down) DE (wilcox) Hallmark pathways in Cluster "
)
```

## PLAGE msigdb C2 [NOT WORKING]
```{r, eval=FALSE, message=FALSE, echo=FALSE, warning=FALSE}
gsva_es <- seu_gsva(
  seu_singlet_tumor,
  category = "C2",
  gsva_type = "plage"
)

# this one also takes a lot of time. save and load the results.
saveRDS(gsva_es, "/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/25-Feb-25_gsva_es_tumor_C2_plage.rds") # nolint
```

```{r, eval=FALSE, echo=FALSE, warning=FALSE}
# as gsva for C2 takes time, save and load .rds with gsva calculated
gsva_es <- readRDS("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/25-Feb-25_gsva_es_tumor_C2_plage.rds") # nolint

gsva_cx <- "GSVA_C2_plage"
seu_singlet_tumor[[gsva_cx]] <- Seurat::CreateAssayObject(data = gsva_es)
Seurat::DefaultAssay(seu_singlet_tumor) <- gsva_cx
```

```{r, eval=FALSE, echo=FALSE, warning=FALSE}
markers <- Seurat::FindAllMarkers(
  seu_singlet_tumor,
  assay = gsva_cx,
  only.pos = FALSE
)
markers_up <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = 20, wt = avg_log2FC)
markers_down <- markers |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  arrange(desc(avg_log2FC)) |>
  top_n(n = -20, wt = avg_log2FC)
top_markers <- bind_rows(markers_up, markers_down) |>
  mutate(upordown = ifelse(avg_log2FC > 0, "up", "down"))
```

```{r, eval=FALSE, fig.width=15, fig.height=8}
datatable(top_markers)

seu_gsva_print_plot(
  top_markers,
  "plageGSVA top 40(20up+20down) DE (wilcox) C2 gene sets in Cluster "
)
```

# GSEA (using fgsea package)
```{r}
DefaultAssay(seu_singlet_tumor) <- "RNA"
gsea_markers <- FindAllMarkers(
  seu_singlet_tumor,
  only.pos = FALSE,
  logfc.threshold = 0,
  min.pct = 0
)
head(gsea_markers)
```

## Hallmark 
```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
for (i in unique(gsea_markers$cluster)) {
  cluster_markers <- gsea_markers |>
    filter(p_val_adj < 0.05) |>
    filter(cluster == i) |>
    mutate(myscore = sign(avg_log2FC) * abs(avg_log2FC) * -log10(p_val_adj))

  ranked_genes <- cluster_markers$myscore
  names(ranked_genes) <- cluster_markers$gene
  ranked_genes <- sort(ranked_genes, decreasing = TRUE)
  ranked_genes <- ranked_genes[is.finite(ranked_genes)]

  top_pathways <- seu_gsea(ranked_genes, "H")
  seu_gsea_plot(top_pathways, "H", i)
}
```

## C2
```{r, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
for (i in unique(gsea_markers$cluster)) {
  cluster_markers <- gsea_markers |>
    filter(p_val_adj < 0.05) |>
    filter(cluster == i) |>
    mutate(myscore = sign(avg_log2FC) * abs(avg_log2FC) * -log10(p_val_adj))

  ranked_genes <- cluster_markers$myscore
  names(ranked_genes) <- cluster_markers$gene
  ranked_genes <- sort(ranked_genes, decreasing = TRUE)
  ranked_genes <- ranked_genes[is.finite(ranked_genes)]

  top_pathways <- seu_gsea(ranked_genes, "C2")
  seu_gsea_plot(top_pathways, "C2", i)
}
```