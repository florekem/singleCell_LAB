---
title: "HIT-GLIO sample1 myeloid clusters annotation"
author: "MF"
date: "`r Sys.Date()`"
---


```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(ggplot2)
  library(Matrix)
  library(tidyverse)
  library(clustree)
  library(reticulate) # load packages required by leiden algo
  reticulate::use_condaenv("/mnt/sda4/conda/envs/R")
  library(viridis) # colors
  options(future.globals.maxSize = 3.0 * 1e9) # 3GB
  library(dittoSeq)
  library(AUCell)
  library(GSVA)
  library(msigdbr)
})
```


```{r}
seu_singlet_myelo <- readRDS("/mnt/sda4/singleCell_LAB/HitGlio_sample1-test/RDS/30-Jan-2025-sue_singlet_myelo") # nolint

set.seed(123)
```

# Predictions:
Microglia: 1
Chemotaxis macrophages: 
Macrophages: 
Monocytes: 
DC: 
Unknown: 
Mes-microglia: 

# Dimplot of subsetted myeloid clusters
```{r}
DimPlot(
  seu_singlet_myelo,
  reduction = "wnn.umap",
  label = TRUE
)

DimPlot(
  seu_singlet_myelo,
  group.by = "MULTI_ID",
  reduction = "wnn.umap",
  label = TRUE
)
```

# CellTypist to predict labels
https://www.celltypist.org/
prediction is based on Immune_ALL_high reference
```{r}
# annot <- read.csv("/mnt/sda4/cell_typist_predicted_labels.csv")
# colnames(annot)
# rownames(annot) <- annot$cell

# seu_singlet_myelo <- AddMetaData(
#   seu_singlet_myelo,
#   metadata = annot
# )

# DimPlot(
#   seu_singlet_myelo,
#   reduction = "umap.myelo.pca.sct",
#   group.by = "predicted_labels",
#   label = TRUE,
#   repel = TRUE
# )
```

# Diff.Expr. Cluster X vs REST
Make lognorm for RNA assay. Subset 100 cells.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
DefaultAssay(seu_singlet_myelo) <- "RNA"

# seu_singlet_myelo <- seu_normalize_var_scale_pca(
#   seu_singlet_myelo,
#   normalize = "log",
#   cluster.name = "cluster.log.myelo",
#   run_pca = TRUE,
#   pca.reduction.name = "pca.myelo.log",
#   umap.reduction.name = "umap.myelo.pca.log",
#   dims = 1:30,
#   k.param = 30,
#   algorithm = 4,
#   resolution = 1.0,
#   group.singletons = FALSE
# )
# keep sct idents on; log is only for DE calculations
# Idents(seu_singlet_myelo) <- "cluster.sct.myelo"
# Idents(seu_singlet_myelo) <- "wsnn_res.0.4"

# DimPlot(seu_singlet_myelo, reduction = "umap.myelo.pca.sct", label = TRUE)
# DimPlot(seu_singlet_myelo, reduction = "wnn.umap", label = TRUE)

# for the reference, this is how log clustering looks like
# DimPlot(seu_singlet_myelo, reduction = "umap.myelo.pca.log", label = TRUE)
```

## subset even number of cells
```{r, echo=FALSE, message=FALSE, warning=FALSE}
table(seu_singlet_myelo@active.ident)

cluster_ids <- Idents(seu_singlet_myelo)

# Initialize an empty list to store the subsetted cells
subset_cells <- list()

# Loop through each cluster and sample cells
for (cluster in unique(cluster_ids)) {
  cells_in_cluster <- WhichCells(seu_singlet_myelo, idents = cluster)
  sampled_cells <- sample(cells_in_cluster, size = 100)
  # size = min(100, length(cells_in_cluster)) # if no of cell smaller than 100, select max cells in cluster # nolint
  subset_cells[[cluster]] <- sampled_cells
}

# Combine the sampled cells into a single vector
subset_cells_all <- unlist(subset_cells)

# Subset the Seurat object
seurat_subset <- subset(seu_singlet_myelo, cells = subset_cells_all)
seurat_subset

seurat_subset <- NormalizeData(seurat_subset)
seurat_subset <- ScaleData(seurat_subset)

table(seurat_subset@active.ident)
```

## Compute differentiall expression
```{r, echo=FALSE, message=FALSE, warning=FALSE}
markers_genes <- FindAllMarkers(
  seurat_subset,
  log2FC.threshold = 0.2,
  test.use = "MAST",
  min.pct = 0.1,
  min.diff.pct = 0.2,
  only.pos = TRUE,
  # max.cells.per.ident = 50, this subsamples randomly every time, better to subsample on your own. # nolint
  assay = "RNA"
)
```

## draw barlopts with top25
```{r}
top25 <- markers_genes %>%
  group_by(cluster) %>%
  top_n(-25, p_val_adj)
```

```{r}
for (i in unique(top25$cluster)) {
  # print genes protted on barplots (top25 genes in each cluster)
  top25 |>
    group_by(cluster) |>
    filter(cluster == i) |>
    select(gene) |>
    as.vector() |>
    print()

  barplot(
    sort(setNames(top25$avg_log2FC, top25$gene)[top25$cluster == i], FALSE),
    horiz = TRUE,
    las = 1,
    main = paste0(i, " vs. rest"),
    border = "white",
    yaxs = "i"
  )
  abline(v = c(0, 0.25), lty = c(1, 2))
}
```

## make heatmap with top 10 genes
```{r, fig.width=10, fig.height=12}
top_x <- markers_genes %>%
  group_by(cluster) %>%
  slice_min(p_val_adj, n = 10, with_ties = FALSE)

seurat_subset_heatmap <- seurat_subset

seurat_subset_heatmap <- ScaleData(
  seurat_subset_heatmap,
  features = as.character(unique(top_x$gene)), assay = "RNA"
)

DoHeatmap(
  seurat_subset_heatmap,
  features = as.character(unique(top_x$gene)),
  # group.by = "cluster.sct.myelo", assay = "RNA"
  group.by = "wsnn_res.0.4", assay = "RNA"
)
```

## make dotplot with top 10 (same viz. as heatmap)
```{r, fig.width=10, fig.height=15}
DotPlot(
  seurat_subset_heatmap,
  features = rev(as.character(unique(top_x$gene))), group.by = "cluster.sct.myelo", assay = "RNA"
) + coord_flip() + mycolor2
```

## validate top10 gene expression on vlnplots
```{r, fig.width=12, fig.height=9}
for (i in unique(top_x$cluster)) {
  top_x_cluster <- top_x |>
    filter(cluster == i)

  print(paste0("cluster: ", i))

  print(VlnPlot(
    seu_singlet_myelo,
    features = top_x_cluster$gene
  ) + patchwork::plot_annotation(
    paste0("Cluster ", i, " top genes"),
    theme = theme(plot.title = element_text(size = 25))
  ))
}
```

# Generate scores of marker gene sets using AUCell
## Run AUCEll
```{r}
expr_matrix <- as.matrix(
  GetAssayData(seu_singlet_myelo, layer = "data", assay = "RNA")
)

gene_rankings <- AUCell_buildRankings(expr_matrix, plotStats = TRUE)
```

### wang2024_hypoxic_macrophages
```{r, echo=TRUE, message=FALSE, warning=FALSE}
print(wang2024_hypoxic_macrophages)

auc_scores <- AUCell_calcAUC(
  wang2024_hypoxic_macrophages,
  gene_rankings
)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_myelo <- AddMetaData(seu_singlet_myelo, metadata = auc_matrix)

map(
  names(wang2024_hypoxic_macrophages),
  ~ FeaturePlot(
    seu_singlet_myelo,
    features = .x,
    pt.size = 1,
    label = TRUE,
    reduction = "wnn.umap"
  ) & mycolor2 & NoAxes()
)

# density w przypadku AUCell scores nie ma sensu, bo mocno przejaskrawia
# map(
#   names(wang2024_hypoxic_macrophages),
#   ~ plot_density(
#     seu_singlet_myelo,
#     .x,
#     size = 1.5,
#     # joint = "TRUE",
#     reduction = "wnn.umap"
#   ) & NoAxes()
# )

# ale spróbujmy density w przypadku samych genów, nie scora
# clean wang2024 list, bc some features are not present in my data, and density_plot need all to be present
valid_features <- function(features_list, seurat_obj) {
  features_list[features_list %in% rownames(seurat_obj)]
}

wang2024_hypoxic_macrophages_cleaned <- map(
  wang2024_hypoxic_macrophages,
  ~ valid_features(.x, seu_singlet_myelo)
)

wang2024_hypoxic_macrophages_cleaned <- map(
  wang2024_hypoxic_macrophages,
  function(x) x[x %in% rownames(seu_singlet_myelo)]
)

imap( # indexed map
  wang2024_hypoxic_macrophages_cleaned,
  ~ plot_density(
    seu_singlet_myelo,
    features = .x,
    size = 1.5,
    joint = TRUE,
    reduction = "wnn.umap"
  ) + patchwork::plot_annotation(
    title = .y, # name of named vector in a list
    theme = theme(plot.title = element_text(size = 25))
  ) & NoAxes()
)




colnames(seu_singlet_myelo@meta.data)
seu_singlet_myelo@meta.data |>
  filter(wsnn_res.0.4 == 4) |>
  select(Monocyte_derived_TAM)
```

### VlnPlot of AUC scores of microglia/macrophages core markers
```{r, fig.width=10, fig.height=12}
# Idents(seu_singlet_myelo) <- "merged_to_one"

mgmc <- list(
  microglia1 = c("HEXB", "TMEM119", "P2RY12"),
  microglia2 = c("CX3CR1", "P2RY12", "P2RY13", "SELPLG"),
  macrophages1 = c("CD163", "CD74", "TGFBI", "IFITM2", "IFITM3", "F13A1", "NPC2", "FTH1") # nolint
)
sapply(mgmc, function(x) x) # print

auc_scores <- AUCell_calcAUC(
  mgmc,
  gene_rankings
)
gene_rankings <- AUCell_buildRankings(expr_matrix, plotStats = FALSE)

auc_matrix <- as.data.frame(t(getAUC(auc_scores)))
seu_singlet_myelo <- AddMetaData(seu_singlet_myelo, metadata = auc_matrix)
```
```{r, fig.width=10, fig.height=4}
VlnPlot(
  seu_singlet_myelo,
  features = c(
    "microglia1",
    "microglia2",
    "macrophages1"
  )
)
```

### FeaturePlot of AUC scores of microglia/macrophages core markers
```{r, fig.width=12, fig.height=6}
FeaturePlot(
  seu_singlet_myelo,
  features = c(
    "microglia1",
    "microglia2",
    "macrophages1"
  ),
  pt.size = 1,
  label = TRUE,
  reduction = "wnn.umap"
) & mycolor2 & NoAxes()

plot_density(
  seu_singlet_myelo,
  features = c(
    "microglia1",
    "microglia2",
    "macrophages1"
  ),
  size = 1.5,
  # joint = "TRUE",
  reduction = "wnn.umap"
) & NoAxes()
```

### Heatmap z-score of microglia/macrophages core markers
```{r, fig.width=10, fig.height=7}
features <- c(mgmc$microglia1, mgmc$microglia2, mgmc$macrophages1)

seu_singlet_myelo_heatmap <- seu_singlet_myelo

seu_singlet_myelo_heatmap <- ScaleData(
  seu_singlet_myelo_heatmap,
  features = features, assay = "RNA"
)

DoHeatmap(
  seu_singlet_myelo_heatmap,
  features = features,
  group.by = "wsnn_res.0.4", assay = "RNA"
)
```

### FeaturePlot of microglia/macrophages selected core markers
```{r, fig.width=10, fig.height=9}
FeaturePlot(
  seu_singlet_myelo,
  c(
    "P2RY12", "TMEM119",
    "CD163", "TGFBI"
  ),
  reduction = "wnn.umap",
  cols = c("lightgrey", "red"),
  pt.size = 1,
  label = TRUE
) & NoAxes()

DefaultAssay(seu_singlet_myelo) <- "RNA"
plot_density(
  seu_singlet_myelo,
  # c(
  #   "P2RY12", "TMEM119",
  #   "CD163", "TGFBI"
  # ),
  "CCR5",
  size = 1.5,
  # joint = "TRUE",
  reduction = "wnn.umap"
) & NoAxes()
```

# ADT features
```{r, eval=FALSE}
DefaultAssay(seu_singlet_myelo) <- "ADT.dsb.threshold"
features <- get_features(seu_singlet_myelo, "ADT.dsb.threshold")
length(features)
f1 <- features[1:10]
f2 <- features[11:21]
f_list <- list(f1, f2)

for (i in seq_along(f_list)) {
  seu_FeaturePlot(
    seu_singlet_myelo, "ADT.dsb.threshold",
    reduction = "wnn.umap",
    color = inferno,
    features = f_list[[i]],
    max.cutoff = NA,
    show = FALSE,
    save_path = paste0("singleCell_LAB/HitGlio_sample1-test/plots/05-feb-25_sct_dsb-threshold_myelo/panel_", i), # nolint
    ggheight = 20,
    ggwidth = 20
  ) & NoAxes()
}

for (i in seq_along(f_list)) {
  plot <- plot_density(
    seu_singlet_myelo,
    features = f_list[[i]],
    reduction = "wnn.umap",
    size = 1.5,
  ) & NoAxes() & inferno

  ggsave(
    paste0("singleCell_LAB/HitGlio_sample1-test/plots/05-feb-25_sct_dsb-threshold_myelo/panel_density_", i, ".png"),
    plot,
    height = 20,
    width = 20
  )
}
?plot_density

DefaultAssay(seu_singlet_myelo) <- "RNA"
```

# GSVA of HALLMARK collection
made on seurat_subset (randomly selected 100 cells from each cluster, the same as for previous analysis)
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=15}
gene_sets <- msigdbr(species = "Homo sapiens", category = "H")
gene_set_list <- split(gene_sets$gene_symbol, gene_sets$gs_name) # wooolooloo

expr_matrix <- as.matrix(
  GetAssayData(
    seurat_subset,
    layer = "data", assay = "RNA"
  )
)

params <- zscoreParam(
  expr_matrix,
  gene_set_list,
  minSize = 10,
  maxSize = 500
)

gsva_es <- gsva(
  params,
  verbose = TRUE
)

gsva_cx <- "GSVA_H"

# seu_singlet_myelo[[gsva_cx]] <- CreateAssayObject(data = gsva_es)
seurat_subset[[gsva_cx]] <- CreateAssayObject(data = gsva_es)

# DefaultAssay(seu_singlet_myelo) <- gsva_Cx
DefaultAssay(seurat_subset) <- gsva_cx

# avg_pathway_scores <- AverageExpression(seu_singlet_myelo, assays = gsva_Cx)$GSVA
avg_pathway_scores <- AverageExpression(seurat_subset, assays = gsva_Cx)$GSVA

markers <- Seurat::FindAllMarkers(
  # seu_singlet_myelo,
  seurat_subset,
  assay = gsva_Cx,
  test_use = "MAST",
  only.pos = TRUE
) |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  top_n(n = 20, wt = avg_log2FC)

# markers_sort <- markers |>
#   filter(cluster == "3") |>
#   arrange(desc(avg_log2FC))
# select(gene)

ggplot(
  markers,
  aes(x = gene, y = cluster, size = avg_log2FC, color = p_val_adj)
) +
  geom_point(aes(fill = p_val_adj < 0.05)) +
  scale_size_continuous(range = c(1, 10)) +
  scale_color_gradient(low = "black", high = "lightgray") +
  coord_flip() +
  labs() +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 11),
    panel.grid.major = element_line(size = 0.5, color = "grey80")
  )
```

# GSVA of C2 (currated gene-sets) collection
made on seurat_subset (randomly selected 100 cells from each cluster, the same as for previous analysis)
```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=15}
gene_sets <- msigdbr(species = "Homo sapiens", category = "C2")
gene_set_list <- split(gene_sets$gene_symbol, gene_sets$gs_name) # wooolooloo

expr_matrix <- as.matrix(
  GetAssayData(
    seurat_subset,
    layer = "data", assay = "RNA"
  )
)

params <- zscoreParam(
  expr_matrix,
  gene_set_list,
  minSize = 10,
  maxSize = 500
)

gsva_es <- gsva(
  params,
  verbose = TRUE
)

gsva_cx <- "GSVA_C2"

# seu_singlet_myelo[[gsva_cx]] <- CreateAssayObject(data = gsva_es)
seurat_subset[[gsva_cx]] <- CreateAssayObject(data = gsva_es)

# DefaultAssay(seu_singlet_myelo) <- gsva_Cx
DefaultAssay(seurat_subset) <- gsva_cx

# avg_pathway_scores <- AverageExpression(seu_singlet_myelo, assays = gsva_Cx)$GSVA
avg_pathway_scores <- AverageExpression(seurat_subset, assays = gsva_Cx)$GSVA

markers <- Seurat::FindAllMarkers(
  # seu_singlet_myelo,
  seurat_subset,
  assay = gsva_Cx,
  test_use = "MAST",
  only.pos = TRUE
) |>
  filter(p_val_adj < 0.05) |>
  group_by(cluster) |>
  top_n(n = 5, wt = avg_log2FC)

# markers_sort <- markers |>
#   filter(cluster == "3") |>
#   arrange(desc(avg_log2FC))
# select(gene)

ggplot(
  markers,
  aes(x = gene, y = cluster, size = avg_log2FC, color = p_val_adj)
) +
  geom_point(aes(fill = p_val_adj < 0.05)) +
  scale_size_continuous(range = c(1, 10)) +
  scale_color_gradient(low = "black", high = "lightgray") +
  coord_flip() +
  labs() +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 11),
    panel.grid.major = element_line(size = 0.5, color = "grey80")
  )
```



## inspect genes
```{r}
top_x_inspect <- markers_genes %>%
  group_by(cluster) %>%
  slice_min(p_val_adj, n = 100, with_ties = FALSE)

top_x_inspect |>
  filter(cluster == 4) |>
  select(gene) |>
  as.vector()

FeaturePlot(
  seu_singlet_myelo,
  # feature = c("TMEM119", "P2RY12", "CD163", "CCR2"),
  # feature = c("TREM2", "CD84"),
  feature = c("CCR5"),
  reduction = "wnn.umap",
  pt.size = 1,
  alpha = 0.8,
) & mycolor3 & NoAxes()

mycolor3 <- viridis::scale_color_viridis(
  option = "viridis",
  alpha = 1,
  begin = 0,
  end = 1,
  direction = 1
)

library(Nebulosa)

plot_density(
  seu_singlet_myelo,
  c("GFAP", "PTPRZ1", "SCG3", "SOX2", "SOX6", "BCAN", "NOVA1", "NRCAM", "TUBB2B"),
  slot = "data",
  size = 1.5,
  joint = "TRUE",
  reduction = "wnn.umap"
) & NoAxes()
?plot_density

Idents(seu_singlet_myelo) <- "wsnn_res.0.4"
VlnPlot(
  seu_singlet_myelo,
  "GFAP"
  # "SOX2"
)
```

```{r}
glioblastoma_proneural <- c(
  "ABAT", "ACTR1A", "ALCAM", "AMOTL2", "KDM1A", "ARHGEF9", "ASCL1", "ATAD5", "ATP1A3", "ADGRB3",
  "BCAN", "BCL7A", "BCOR", "BEX1", "C1QL1", "INAVA", "MIR9-1HG", "FERMT1", "ATAT1", "CA10",
  "CAMSAP2", "CASK", "CBX1", "CDC25A", "CDC7", "CDK5R1", "CDKN1B", "CHD7", "CKB", "CLASP2",
  "CLGN", "CNTN1", "CRB1", "CRMP1", "CSNK1E", "CSPG5", "CXXC4", "DBN1", "DCX", "DGKI", "DLL3",
  "DNM3", "DPF1", "DPP6", "DPYSL4", "DUSP26", "E2F3", "EPB41", "EPHB1", "ERBB3", "FAM110B",
  "MVB12B", "NKAIN1", "FBXO21", "FGF9", "FHOD3", "FLRT1", "FXYD6", "GABRA3", "GADD45G", "GNG4",
  "GPM6A", "GPR17", "LPAR4", "GRIA2", "GRID2", "GSK3B", "GSTA4", "HDAC2", "HMGB3", "JPT1",
  "HOXD3", "PLAAT1", "CILK1", "IL1RAPL1", "ZC4H2", "KIF21B", "KLRC3", "KLRC4", "KLRK1", "ZNF821",
  "REXO5", "ADGRL3", "LRP6", "LRRTM4", "MAP2", "MAPT", "MARCKS", "MARCKSL1", "MAST1", "MATR3",
  "MCM10", "MLLT11", "MMP15", "MMP16", "MPPED2", "MTSS1", "MYB", "MYO10", "KAT7", "MYT1",
  "NCALD", "NCAM1", "NKX2-2", "NLGN3", "NOL4", "NR0B1", "NRXN1", "NRXN2", "OLIG2", "P2RX7",
  "PAFAH1B3", "PAK3", "PAK5", "PCDH11X", "PCDH11Y", "PDE10A", "PELI1", "PFN2", "JADE3", "PHLPP1",
  "PLCB4", "PODXL2", "PPM1D", "PPM1E", "PURG", "RAB33A", "RAD21", "RALGPS1", "RALGPS2", "RAP2A",
  "RBPJ", "REEP1", "RUFY3", "SATB1", "SCG3", "SCN3A", "SEC61A2", "SEZ6L", "SLC1A1", "SLCO5A1",
  "ARHGAP33", "SORCS3", "SOX10", "SOX11", "SOX2", "SOX4", "SPTBN2", "SRGAP3", "STMN1", "STMN4",
  "TAF5", "TMCC1", "TMEFF1", "RNFT2", "TMEM35A", "TMSB15A", "CELF3", "TOP2B", "TOPBP1", "TOX3",
  "TSPAN3", "TTC3", "TTYH1", "VAX2", "VEZF1", "WASF1", "DCAF7", "YPEL1", "ZEB2", "ZNF184",
  "ZNF248", "ZNF286A", "ZNF510", "ZFP69B", "ZNF711", "ZNF804A"
)

test <- glioblastoma_proneural %in% top_x_inspect
```